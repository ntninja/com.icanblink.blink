app-id: com.icanblink.blink
runtime: org.kde.Platform
runtime-version: "6.10"
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
base: com.riverbankcomputing.PyQt.BaseApp
base-version: "6.10"
cleanup-commands:
  - /app/cleanup-BaseApp.sh
command: blink
finish-args:
  - --device=all
  - --filesystem=xdg-download
  - --filesystem=~/.blink:create
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=fallback-x11
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.gtk.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
cleanup:
  - /lib/*.a
  - /lib/*.la
  # Build dependencies
  - /lib/python3.??/site-packages/filelock*/
  - /lib/python3.??/site-packages/httpx*/
  - /bin/httpx
  - /lib/python3.??/site-packages/platformdirs*/
  - /lib/python3.??/site-packages/semantic_version*/
  - /lib/python3.??/site-packages/tqdm*/
  - /bin/tqdm
  - /lib/python3.??/site-packages/setuptools_rust*/
  - /lib/python3.??/site-packages/puccinialin*/
  - /bin/puccinialize
  - /lib/python3.??/site-packages/maturin*/
  # python3-twisted scripts
  - /bin/cftp
  - /bin/ckeygen
  - /bin/conch
  - /bin/mailmail
  - /bin/pyhtmlizer
  - /bin/tkconch
  - /bin/trial
  - /bin/twist
  - /bin/twistd

  - /lib*/cmake
  - /lib*/debug
  - /lib*/pkgconfig
  - /share/man
  - /share/cmake
modules:

  - name: libvncserver
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_POLICY_VERSION_MINIMUM=3.5
    sources:
      - type: archive
        url: https://github.com/LibVNC/libvncserver/archive/refs/tags/LibVNCServer-0.9.15.tar.gz
        sha512: 3ad7e14eef3b591574714e320257ac465778e05bd157ddff09e48b990f35890bfa6883ce4ac027fcb08dccd96f721117d56aaee681482f7643cfee9adc59804b

  - name: x11vnc
    sources:
      - type: archive
        url: https://github.com/LibVNC/x11vnc/archive/refs/tags/0.9.17.tar.gz
        sha512: 687c41e03cca43dbca6ffdeb40960dddfba54ba00cf890f89f63fd66b9559a4c09602f84c1d4b7ffd7ac58818b90893013925d94a45a6feb83ab8cf7a02c1fe8

  # Required by gmpy2
  - name: mpc
    buildsystem: autotools
    sources:
      - type: archive
        url: https://ftp.gnu.org/gnu/mpc/mpc-1.3.1.tar.gz
        sha512: 4bab4ef6076f8c5dfdc99d810b51108ced61ea2942ba0c1c932d624360a5473df20d32b300fc76f2ba4aa2a97e1f275c9fd494a1ba9f07c4cb2ad7ceaeb1ae97

  # Install Blink Python dependencies
  - pypi-dependencies.json

  # Install Blink AGProjects dependencies
  - name: python3-application
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/AGProjects/python3-application
        tag: release-3.0.9
        commit: d13e68fa63f3dcb1d22597898481084e80e4efb8
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --prefix="${FLATPAK_DEST}" --no-build-isolation .

  - name: python3-eventlib
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/AGProjects/python3-eventlib
        #tag: 0.3.0-dirty
        commit: 67d20654a2335299382b01fc2d08b645bcdac9e1
      - type: patch
        path: patches/python3-eventlib/01-green-socket-context-manager.patch
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --prefix="${FLATPAK_DEST}" --no-build-isolation .

  - name: python3-gnutls
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/AGProjects/python3-gnutls
        #tag: release-3.1.11  # ← missing
        commit: d0fa84b781ccd2a7e500e4fc8cb7a97d9724ec7d
      - type: patch
        path: patches/python3-gnutls/01-optional-deps-and-setuptools.patch
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --prefix="${FLATPAK_DEST}" --no-build-isolation .

  - name: python3-otr
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/AGProjects/python3-otr
        tag: 2.1.0
        commit: 0a950d29b91daa98c30ab93bb93fb87d2831e2a5
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --prefix="${FLATPAK_DEST}" --no-build-isolation .

  - name: python3-msrplib
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/AGProjects/python3-msrplib
        #tag: 0.21.1  # ← missing
        commit: 5bd069620d436d5a65e1c369e43cc6b88857fb9e
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --prefix="${FLATPAK_DEST}" --no-build-isolation .

  - name: python3-xcaplib
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/AGProjects/python3-xcaplib
        #tag: 2.0.1-dirty
        commit: 925846f2520d823f0b83279ceca6202808a4ca4f
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --prefix="${FLATPAK_DEST}" --no-build-isolation .

  - name: python3-sipsimple
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/AGProjects/python3-sipsimple
        #tag: 5.3.3-2-dirty
        commit: cdd2cb474402e83a906de8eb07ce11ddd27ee150
      - type: file
        url: https://github.com/pjsip/pjproject/archive/refs/tags/2.11.1.tar.gz
        sha512: fda8e4bf9d5f34d3940c69414a20f177d09ca79c76753f6597326f8afc72f847dd70df4e1f2c34fae173f5728d5ac1419ed602651c68167c747c40280dbe117e
        dest: deps
        dest-filename: 2.11.1.tar.gz
      - type: git
        url: https://github.com/wernerd/ZRTPCPP
        commit: 6b3cd8e6783642292bad0c21e3e5e5ce45ff3e03
        dest: deps/ZRTPCPP
      - type: patch
        paths:
          - patches/python3-sipsimple/01-fix-zrtp-cstdint-include.patch
          - patches/python3-sipsimple/02-fix-get-dependencies-script.patch
          - patches/python3-sipsimple/03-fix-alsa-backend-compilation.patch
          - patches/python3-sipsimple/04-drop-already-applied-patches.patch
    build-commands:
      - AUTOINSTALL=0 ./get_dependencies.sh 2.11.1
      - pip3 install --verbose --exists-action=i --no-index --prefix="${FLATPAK_DEST}" --no-build-isolation .

  # Install Blink from source
  - name: blink-qt
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/AGProjects/blink-qt
        #tag: 6.0.4-dirty
        commit: d8b15038f5bd04d9b22a25397135db733573318f
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --prefix="${FLATPAK_DEST}" --no-build-isolation .
      # Install desktop files
      - desktop-file-edit --set-icon=${FLATPAK_ID} debian/blink.desktop
      - install -Dm 644 debian/blink.desktop "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
      - install -Dm 644 resources/icons/blink.png "${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png"

  # Install application files
  - name: blink-desktop
    buildsystem: simple
    sources:
      - type: file
        path: com.icanblink.blink.metainfo.xml
    build-commands:
      - install -Dm644 "${FLATPAK_ID}.metainfo.xml" "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml"
